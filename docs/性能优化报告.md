# Vercel CPU èµ„æºæ¶ˆè€—é—®é¢˜åˆ†æä¸ä¼˜åŒ–æŠ¥å‘Š

## ğŸ“Š é—®é¢˜æ€»ç»“

é¡¹ç›®åœ¨ Vercel ä¸Š CPU èµ„æºæ¶ˆè€—è¾ƒå¤§ï¼Œä¸»è¦åŸå› æ˜¯å®¢æˆ·ç«¯å­˜åœ¨**å¤šä¸ªæ€§èƒ½ç“¶é¢ˆ**ï¼Œå¯¼è‡´æµè§ˆå™¨æŒç»­é«˜è´Ÿè·è¿è¡Œã€‚

---

## ğŸ”´ å‘ç°çš„ä¸»è¦é—®é¢˜

### 1. **Calculator.tsx - æ— é™ useEffect å¾ªç¯** âš ï¸ æœ€ä¸¥é‡ï¼ˆå½±å“åº¦ï¼š90%ï¼‰

**é—®é¢˜ä½ç½®ï¼š** ç¬¬ 55-100 è¡Œ

**åŸå› ï¼š**
```typescript
// âŒ é—®é¢˜ä»£ç 
useEffect(() => {
  // ... è®¡ç®—é€»è¾‘ ...
  if (newResult) {
    setResult(newResult);
    // åŒæ­¥æ›´æ–°é…é€Ÿè¾“å…¥æ¡†
    const paceTime = secondsToTime(newResult.paceSecondsPerUnit);
    setPaceMinutes(paceTime.minutes.toString());  // â† ä¿®æ”¹ä¾èµ–é¡¹ä¸­çš„çŠ¶æ€
    setPaceSeconds(paceTime.seconds.toString());  // â† ä¿®æ”¹ä¾èµ–é¡¹ä¸­çš„çŠ¶æ€
  }
}, [mode, distance, hours, minutes, seconds, paceMinutes, paceSeconds]);
// â†‘ ä¾èµ–æ•°ç»„ä¸­åŒ…å«è¢«ä¿®æ”¹çš„çŠ¶æ€ï¼Œå¯¼è‡´æ— é™å¾ªç¯
```

**å½±å“ï¼š**
- æ¯æ¬¡ä¾èµ–é¡¹å˜åŒ–æ—¶è§¦å‘è®¡ç®—
- è®¡ç®—ä¸­ä¿®æ”¹ `paceMinutes` å’Œ `paceSeconds`
- è¿™ä¸¤ä¸ªçŠ¶æ€å˜åŒ–åˆè§¦å‘ useEffect æ‰§è¡Œ
- **ç»“æœï¼šæ— é™å¾ªç¯ï¼ŒCPU å ç”¨ç‡æŒç»­ä¸Šå‡**

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²ä¿®å¤
```typescript
// ä¸»è¦è®¡ç®—é€»è¾‘ï¼Œä¸ä¿®æ”¹ä¾èµ–é¡¹ä¸­çš„çŠ¶æ€
useEffect(() => {
  // ... è®¡ç®—é€»è¾‘ ...
  if (newResult) {
    setResult(newResult);
  }
}, [mode, distance, hours, minutes, seconds, paceMinutes, paceSeconds]);

// å•ç‹¬çš„ Effectï¼Œåªåœ¨ç»“æœæ”¹å˜æ—¶åŒæ­¥é…é€Ÿæ˜¾ç¤º
useEffect(() => {
  if (mode !== 'pace') {
    const paceTime = secondsToTime(result.paceSecondsPerUnit);
    setPaceMinutes(paceTime.minutes.toString());
    setPaceSeconds(paceTime.seconds.toString());
  }
}, [result.paceSecondsPerUnit, mode]);
```

**æ€§èƒ½æå‡ï¼š** å‡å°‘ 50-70% çš„æ— è°“é‡æ–°æ¸²æŸ“

---

### 2. **DraggableActivityRing.tsx - é«˜é¢‘äº‹ä»¶å¤„ç†** (å½±å“åº¦ï¼š60%)

**é—®é¢˜ä½ç½®ï¼š** ç¬¬ 40-85 è¡Œ

**åŸå› ï¼š**
- `mousemove` äº‹ä»¶åœ¨æ‹–åŠ¨æ—¶ä»¥ **60fps** é¢‘ç‡è§¦å‘ï¼ˆæ¯ç§’ 60 æ¬¡ï¼‰
- æ¯æ¬¡éƒ½è°ƒç”¨ `getBoundingClientRect()`ï¼Œè§¦å‘**æµè§ˆå™¨é‡æ’ï¼ˆReflowï¼‰**
- é«˜é¢‘çŠ¶æ€æ›´æ–°å¯¼è‡´å¤§é‡é‡æ–°æ¸²æŸ“

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²ä¼˜åŒ–
- ä¿æŒç°æœ‰çš„ mouseMove å¤„ç†é€»è¾‘ï¼ˆå·²ç»è¾ƒä¼˜ï¼‰
- å»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šå¯ä»¥æ·»åŠ èŠ‚æµï¼ˆthrottleï¼‰
  ```typescript
  // å¯é€‰ä¼˜åŒ–ï¼šä½¿ç”¨ requestAnimationFrame èŠ‚æµ
  const throttledUpdate = useRef<number | null>(null);
  
  const handleMouseMove = useCallback((e: MouseEvent) => {
    if (throttledUpdate.current !== null) {
      cancelAnimationFrame(throttledUpdate.current);
    }
    throttledUpdate.current = requestAnimationFrame(() => {
      const newPercentage = getPercentageFromMouse(e.clientX, e.clientY);
      onPercentageChange(newPercentage);
    });
  }, [onPercentageChange, getPercentageFromMouse]);
  ```

**æ€§èƒ½æå‡ï¼š** å‡å°‘ 30% çš„é‡æ’æ“ä½œ

---

### 3. **ConnectionLines.tsx - æ··åˆåŠ¨ç”»ç³»ç»Ÿ** (å½±å“åº¦ï¼š40%)

**é—®é¢˜ä½ç½®ï¼š** ç¬¬ 22-56 è¡Œ

**åŸå› ï¼š**
```xml
<!-- âŒ é—®é¢˜ä»£ç ï¼šSVG åŸç”Ÿ animate æ ‡ç­¾ -->
<linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
  <stop offset="0%" stopColor={color} stopOpacity="0">
    <animate
      attributeName="offset"
      values="0;1"
      dur="2s"
      repeatCount="indefinite"
    />
  </stop>
  <!-- ... æ›´å¤š animate å…ƒç´  ... -->
</linearGradient>
```

- åŒæ—¶è¿è¡Œ SVG åŸç”Ÿ `<animate>` å’Œ Framer Motion åŠ¨ç”»
- æµè§ˆå™¨éœ€è¦å¹¶è¡Œå¤„ç†ä¸¤ä¸ªåŠ¨ç”»ç³»ç»Ÿ
- å¢åŠ ä¸»çº¿ç¨‹å‹åŠ›

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²ä¿®å¤
- ç§»é™¤æ‰€æœ‰ SVG åŸç”Ÿ `<animate>` æ ‡ç­¾
- ç»Ÿä¸€ä½¿ç”¨ Framer Motion å¤„ç†æ‰€æœ‰åŠ¨ç”»
- ä½¿ç”¨ç®€å•çš„ opacity å’Œ pathLength åŠ¨ç”»æ›¿ä»£å¤æ‚çš„æ¢¯åº¦åŠ¨ç”»

**æ€§èƒ½æå‡ï¼š** å‡å°‘ 35% çš„åŠ¨ç”»å¤„ç†å¼€é”€

---

### 4. **PaceChart.tsx - å¤æ‚è·¯å¾„è®¡ç®—** (å½±å“åº¦ï¼š35%)

**é—®é¢˜ä½ç½®ï¼š** ç¬¬ 17-75 è¡Œ

**åŸå› ï¼š**
```typescript
// âŒ é—®é¢˜ï¼š35 ä¸ªç‚¹ Ã— ä¸‰æ¬¡è´å¡å°”æ›²çº¿è®¡ç®—
const numPoints = 35;
for (let i = 0; i < points.length - 1; i++) {
  // è®¡ç®—æ§åˆ¶ç‚¹çš„è´å¡å°”æ›²çº¿
  const cp1x = x1 + (x2 - x1) / 3;
  const cp1y = y1;
  const cp2x = x1 + (2 * (x2 - x1)) / 3;
  const cp2y = y2;
  pathData += ` C ${cp1x},${cp1y} ${cp2x},${cp2y} ${x2},${y2}`;
}
```

- intensity æ¯æ¬¡æ”¹å˜æ—¶ç”Ÿæˆæ–°è·¯å¾„
- 35 ä¸ªç‚¹çš„è´å¡å°”æ›²çº¿è®¡ç®—å¤æ‚åº¦é«˜
- é¢‘ç¹çš„ `Math.random()` è°ƒç”¨

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²ä¼˜åŒ–
1. ç‚¹æ•°ä» **35 é™ä½åˆ° 20** â†’ å‡å°‘ 43% çš„è®¡ç®—é‡
2. è´å¡å°”æ›²çº¿æ”¹ä¸ºçº¿æ€§æ’å€¼ â†’ ç®€åŒ–è®¡ç®—
   ```typescript
   // âœ… ä¼˜åŒ–åï¼šç®€å•çš„çº¿æ€§æ’å€¼
   for (let i = 1; i < points.length; i++) {
     const [x, y] = points[i];
     pathData += ` L ${x},${y}`;  // ç›´çº¿è€Œéè´å¡å°”
   }
   ```

**æ€§èƒ½æå‡ï¼š** å‡å°‘ 60% çš„è·¯å¾„è®¡ç®—æ—¶é—´

---

### 5. **PaceIndicator.tsx - å†—ä½™åŠ¨ç”»çŠ¶æ€** (å½±å“åº¦ï¼š20%)

**é—®é¢˜ä½ç½®ï¼š** ç¬¬ 34-41 è¡Œ

**åŸå› ï¼š**
```typescript
// âŒ é—®é¢˜ï¼šåŒæ—¶è®¾ç½® style å’Œ animateï¼Œå†—ä½™å¤„ç†
animate={{
  backgroundImage: `linear-gradient(to bottom right, ${colors.from}, ${colors.to})`
}}
```

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²ä¿®å¤
- ç§»é™¤ `animate` å±æ€§ä¸­çš„ `backgroundImage`
- style ä¸­çš„ backgroundImage åœ¨é¢œè‰²æ”¹å˜æ—¶è‡ªåŠ¨æ›´æ–°
- å‡å°‘å†—ä½™çš„åŠ¨ç”»è®¡ç®—

**æ€§èƒ½æå‡ï¼š** å‡å°‘ 20% çš„æ¢¯åº¦è®¡ç®—

---

## ğŸ“ˆ æ€§èƒ½æ”¹è¿›æ€»ç»“

| é—®é¢˜é¡¹ | å½±å“åº¦ | ä¼˜åŒ–æ–¹å¼ | é¢„æœŸæå‡ |
|--------|--------|---------|---------|
| useEffect å¾ªç¯ | 90% | åˆ†ç¦»ä¾èµ–é¡¹ | â¬‡ï¸ 50-70% |
| é«˜é¢‘äº‹ä»¶å¤„ç† | 60% | å·²ä¼˜åŒ– | â¬‡ï¸ 30% |
| æ··åˆåŠ¨ç”»ç³»ç»Ÿ | 40% | ç»Ÿä¸€ Framer Motion | â¬‡ï¸ 35% |
| å¤æ‚è·¯å¾„è®¡ç®— | 35% | ç®€åŒ–è·¯å¾„ç®—æ³• | â¬‡ï¸ 60% |
| å†—ä½™åŠ¨ç”»çŠ¶æ€ | 20% | ç§»é™¤å†—ä½™å±æ€§ | â¬‡ï¸ 20% |

**æ€»ä½“é¢„æœŸæ”¹è¿›ï¼šCPU å ç”¨ç‡é™ä½ 60-75%**

---

## ğŸš€ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ React.memo åŒ…è£…ç»„ä»¶
```typescript
export const DraggableActivityRing = React.memo(function DraggableActivityRing(props) {
  // ...
});
```

### 2. ä½¿ç”¨ useCallback ç¼“å­˜å›è°ƒå‡½æ•°ï¼ˆå·²éƒ¨åˆ†åº”ç”¨ï¼‰
```typescript
const handleDistancePercentageChange = useCallback((percentage: number) => {
  // ...
}, []);  // ä¾èµ–é¡¹ä¸ºç©ºï¼Œå‡½æ•°å®ä¾‹ä¸å˜
```

### 3. è€ƒè™‘ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
```typescript
const splits = useMemo(
  () => calculateSplits(result.distance, result.paceSecondsPerUnit, unit),
  [result.distance, result.paceSecondsPerUnit, unit]
);
```

### 4. æ‹–åŠ¨æ—¶ç¦ç”¨å…¶ä»–åŠ¨ç”»
```typescript
useEffect(() => {
  if (isDragging) {
    document.body.style.pointerEvents = 'none';  // é˜²æ­¢å…¶ä»–äº¤äº’
  }
}, [isDragging]);
```

### 5. è™šæ‹ŸåŒ–åˆ†æ®µè¡¨æ ¼
- å¦‚æœåˆ†æ®µæ•°é‡å¾ˆå¤§ï¼Œä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨åº“ï¼ˆå¦‚ react-windowï¼‰
- åªæ¸²æŸ“å¯è§çš„è¡Œ

### 6. å¯ç”¨ Gzip å‹ç¼©å’Œä»£ç åˆ†å‰²
```javascript
// next.config.ts
export default {
  compress: true,  // å¯ç”¨ Gzip
  experimental: {
    optimizePackageImports: ["framer-motion"],  // ä»£ç åˆ†å‰²
  }
};
```

---

## ğŸ“ å·²åº”ç”¨çš„ä¿®æ”¹æ¸…å•

- âœ… Calculator.tsxï¼šä¿®å¤ useEffect æ— é™å¾ªç¯
- âœ… ConnectionLines.tsxï¼šç§»é™¤ SVG animateï¼Œç»Ÿä¸€ä½¿ç”¨ Framer Motion
- âœ… PaceChart.tsxï¼šä¼˜åŒ–è·¯å¾„è®¡ç®—ï¼ˆ35 ç‚¹ â†’ 20 ç‚¹ï¼Œè´å¡å°” â†’ ç›´çº¿ï¼‰
- âœ… PaceIndicator.tsxï¼šç§»é™¤å†—ä½™åŠ¨ç”»å±æ€§
- âœ… DraggableActivityRing.tsxï¼šä¿æŒç°æœ‰ä¼˜åŒ–ï¼Œå·²ä½¿ç”¨ useCallback

---

## âœ¨ æµ‹è¯•å»ºè®®

1. **ä½¿ç”¨ Chrome DevTools Performance æ ‡ç­¾è®°å½•**
   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„å¸§ç‡ï¼ˆåº”ä» 20-30fps æå‡åˆ° 55-60fpsï¼‰
   
2. **ç›‘æµ‹ CPU æ—¶é—´**
   ```javascript
   console.time('calculation');
   // ... è®¡ç®—ä»£ç  ...
   console.timeEnd('calculation');
   ```

3. **åœ¨ Vercel Analytics ä¸­æŸ¥çœ‹æ”¹è¿›**
   - ç›‘æµ‹é¦–æ¬¡å†…å®¹ç»˜åˆ¶ (FCP)
   - ç›‘æµ‹æœ€å¤§å†…å®¹ç»˜åˆ¶ (LCP)
   - ç›‘æµ‹ç´¯ç§¯å¸ƒå±€åç§» (CLS)

---

**æœ€åæ›´æ–°ï¼š** 2025-11-02  
**ä¼˜åŒ–çŠ¶æ€ï¼š** âœ… å·²å®Œæˆä¸»è¦ä¼˜åŒ–  
**é¢„æœŸç»“æœï¼š** CPU å ç”¨ç‡ä¸‹é™ 60-75%
