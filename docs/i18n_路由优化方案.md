# ğŸŒ `/[locale]` è¯­è¨€åˆ‡æ¢è·¯ç”± CPU ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜åˆ†æ

### å½“å‰çŠ¶æ€
- **ä½¿ç”¨æ¡†æ¶**: next-intl v4.3.12 (Next.js 15.5.5 é€‚é…)
- **è·¯ç”±ç»“æ„**: `app/[locale]/layout.tsx` + `app/[locale]/page.tsx`
- **ä¸­é—´ä»¶**: `middleware.ts` (åŸºäº next-intl)
- **æ¶ˆæ¯åŠ è½½**: åŠ¨æ€å¯¼å…¥ (Dynamic import)
- **i18n é…ç½®**: `localePrefix: 'as-needed'`

### CPU å ç”¨çš„ä¸»è¦åŸå› 

#### 1. **ä¸­é—´ä»¶æ‰§è¡Œé¢‘ç‡é«˜** âš ï¸ (30-40% CPU å ç”¨)
```
æ¯æ¬¡è¯·æ±‚ â†’ middleware.ts æ£€æŸ¥è¯­è¨€ â†’ åˆ›å»º Middleware å®ä¾‹ â†’ æ€§èƒ½å¼€é”€
```

**é—®é¢˜:**
- `matcher` è¿‡äºå®½æ³›: `'/((?!api|_next/static|_next/image|favicon.ico).*)'`
- åŒ…å«äº†å¾ˆå¤šä¸å¿…è¦çš„é™æ€èµ„æºæ£€æŸ¥
- æ¯æ¬¡å¯¼èˆªéƒ½éœ€è¦é‡æ–°å¤„ç† locale å‚æ•°

#### 2. **æ¶ˆæ¯æ–‡ä»¶åŠ¨æ€å¯¼å…¥æ— ç¼“å­˜** âš ï¸ (20-30% CPU å ç”¨)
```typescript
// i18n.ts ç¬¬ 15 è¡Œ - æ¯æ¬¡éƒ½æ‰§è¡Œ
messages: (await import(`./messages/${locale}.json`)).default
```

**é—®é¢˜:**
- åŠ¨æ€å¯¼å…¥æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæ¯ä¸ª locale éƒ½ä¼šåŠ¨æ€ç”Ÿæˆæ–°çš„å¯¼å…¥
- æ²¡æœ‰é¢„åŠ è½½ï¼Œæ²¡æœ‰ç¼“å­˜ç­–ç•¥
- æ¯ä¸ªè·¯ç”±å˜åŒ–éƒ½éœ€è¦é‡æ–°å¯¼å…¥

#### 3. **generateMetadata ä¸­é‡å¤çš„å­—å…¸** (10-15% CPU å ç”¨)
```typescript
// app/[locale]/layout.tsx ç¬¬ 26-38 è¡Œ
const titles: Record<string, string> = {
  en: 'Marathon Pace Calculator',
  zh: 'é©¬æ‹‰æ¾é…é€Ÿè®¡ç®—å™¨',
  // ...
};
```

**é—®é¢˜:**
- æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°çš„å¯¹è±¡
- åº”è¯¥æå–ä¸ºå¸¸é‡æˆ–ä»æ¶ˆæ¯æ–‡ä»¶è¯»å–

#### 4. **LanguageSelector ç»„ä»¶é«˜é¢‘é‡æ¸²æŸ“** (15-25% CPU å ç”¨)
```typescript
// app/[locale]/page.tsx ç¬¬ 53-87 è¡Œ - å®¢æˆ·ç«¯ç»„ä»¶
function LanguageSelector({ currentLocale }: { currentLocale: string }) {
  const languageNames: Record<string, string> = {
    en: 'English',
    zh: 'ä¸­æ–‡',
    // ...
  };
  // æ¯æ¬¡éƒ½éå† locales
  locales.map((loc) => ...)
}
```

**é—®é¢˜:**
- åœ¨æœåŠ¡å™¨ç»„ä»¶ä¸­å´åŒ…å«å®¢æˆ·ç«¯é€»è¾‘
- æ¯æ¬¡åˆ‡æ¢è¯­è¨€ï¼Œæ•´ä¸ªé¡µé¢éƒ½éœ€è¦é‡æ–°è®¡ç®—
- Link ç»„ä»¶å¯¼èˆªå¯èƒ½è§¦å‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

#### 5. **getMessages() è°ƒç”¨æœªä¼˜åŒ–** (10-20% CPU å ç”¨)
```typescript
// app/[locale]/layout.tsx ç¬¬ 67 è¡Œ
const messages = await getMessages();
```

**é—®é¢˜:**
- æ¯ä¸ª locale å˜åŒ–éƒ½è°ƒç”¨ getMessages()
- æ²¡æœ‰çº§è”ç¼“å­˜
- next-intl å†…éƒ¨å¯èƒ½æœ‰å¤šæ¬¡æŸ¥è¯¢

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä»æ˜“åˆ°éš¾ï¼‰

### æ–¹æ¡ˆ 1: ä¼˜åŒ–ä¸­é—´ä»¶ matcherï¼ˆå¿«é€Ÿæ”¶ç›Š: 20-25%ï¼‰

**æ–‡ä»¶**: `middleware.ts`

**åŸå› **: å½“å‰ matcher å¤ªå®½æ³›ï¼Œå¯¼è‡´æ¯ä¸ªè¯·æ±‚éƒ½ç»è¿‡ä¸­é—´ä»¶å¤„ç†

**ä¼˜åŒ–æ­¥éª¤**:

```typescript
// middleware.ts - ä¼˜åŒ–ç‰ˆæœ¬
import createMiddleware from 'next-intl/middleware';
import { routing } from './i18n.config';

export default createMiddleware(routing);

export const config = {
  // âŒ æ—§: ä¼šåŒ¹é…æ‰€æœ‰éé™æ€èµ„æºçš„è¯·æ±‚
  // matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)']
  
  // âœ… æ–°: åªåŒ¹é… locale è·¯ç”±
  matcher: [
    // åŒ¹é… locale å‰ç¼€è·¯ç”±
    '/(en|zh|fr|es)/:path*',
    // åŒ¹é…æ ¹è·¯ç”±
    '/',
    // ä¸åŒ…æ‹¬å†…éƒ¨è·¯ç”±å’Œé™æ€èµ„æº
    '/((?!_next|api|favicon.ico|manifest.json|sitemap.xml|robots.txt|.*\\.\\w+$).*)'
  ]
};
```

**é¢„æœŸæ”¹è¿›**: å‡å°‘ä¸­é—´ä»¶è°ƒç”¨ 40-50%ï¼ŒCPU â†“ 20-25%

---

### æ–¹æ¡ˆ 2: æ¶ˆæ¯æ–‡ä»¶é¢„åŠ è½½ + ç¼“å­˜ï¼ˆæ”¶ç›Š: 15-20%ï¼‰

**æ–‡ä»¶**: `i18n.ts`

**åŸå› **: åŠ¨æ€å¯¼å…¥æ¯æ¬¡éƒ½è®¡ç®—ï¼Œæ²¡æœ‰ç¼“å­˜

**ä¼˜åŒ–æ­¥éª¤**:

```typescript
// i18n.ts - ä¼˜åŒ–ç‰ˆæœ¬
import { getRequestConfig } from 'next-intl/server';
import { routing } from './i18n.config';

// âœ… åˆ›å»ºæ¶ˆæ¯ç¼“å­˜
const messageCache = new Map<string, Record<string, any>>();

// âœ… é¢„åŠ è½½æ‰€æœ‰æ¶ˆæ¯
async function preloadMessages() {
  for (const locale of routing.locales) {
    if (!messageCache.has(locale)) {
      const messages = (await import(`./messages/${locale}.json`)).default;
      messageCache.set(locale, messages);
    }
  }
}

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale;

  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale;
  }

  // âœ… ä¼˜å…ˆä»ç¼“å­˜è¯»å–
  let messages = messageCache.get(locale);
  if (!messages) {
    await preloadMessages();
    messages = messageCache.get(locale) || (await import(`./messages/${locale}.json`)).default;
  }

  return {
    locale,
    messages
  };
});
```

**é¢„æœŸæ”¹è¿›**: CPU â†“ 15-20%

---

### æ–¹æ¡ˆ 3: æå–å…ƒæ•°æ®å¸¸é‡ï¼ˆæ”¶ç›Š: 8-12%ï¼‰

**æ–‡ä»¶**: `app/[locale]/layout.tsx`

**åŸå› **: æ¯æ¬¡éƒ½åˆ›å»ºæ–°å¯¹è±¡

**ä¼˜åŒ–æ­¥éª¤**:

åˆ›å»ºæ–°æ–‡ä»¶ `lib/metadata.ts`:

```typescript
// lib/metadata.ts
export const LOCALE_TITLES: Record<string, string> = {
  en: 'Marathon Pace Calculator',
  zh: 'é©¬æ‹‰æ¾é…é€Ÿè®¡ç®—å™¨',
  fr: 'Calculateur d\'Allure Marathon',
  es: 'Calculadora de Ritmo de MaratÃ³n'
};

export const LOCALE_DESCRIPTIONS: Record<string, string> = {
  en: 'Calculate your running pace, time, or distance with an interactive dashboard',
  zh: 'ä½¿ç”¨äº¤äº’å¼ä»ªè¡¨æ¿è®¡ç®—æ‚¨çš„è·‘æ­¥é…é€Ÿã€æ—¶é—´æˆ–è·ç¦»',
  fr: 'Calculez votre allure, temps ou distance de course avec un tableau de bord interactif',
  es: 'Calcula tu ritmo, tiempo o distancia de carrera con un panel interactivo'
};

export const LANGUAGE_NAMES: Record<string, string> = {
  en: 'English',
  zh: 'ä¸­æ–‡',
  fr: 'FranÃ§ais',
  es: 'EspaÃ±ol'
};
```

ä¿®æ”¹ `app/[locale]/layout.tsx`:

```typescript
import { LOCALE_TITLES, LOCALE_DESCRIPTIONS } from '@/lib/metadata';

export async function generateMetadata({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;

  return {
    title: LOCALE_TITLES[locale] || LOCALE_TITLES.en,
    description: LOCALE_DESCRIPTIONS[locale] || LOCALE_DESCRIPTIONS.en,
    icons: {
      icon: [
        { url: '/favicon.ico', type: 'image/x-icon' }
      ],
      shortcut: ['/favicon.ico']
    }
  };
}
```

**é¢„æœŸæ”¹è¿›**: CPU â†“ 8-12%

---

### æ–¹æ¡ˆ 4: ä¼˜åŒ– LanguageSelector ç»„ä»¶ï¼ˆæ”¶ç›Š: 12-18%ï¼‰

**æ–‡ä»¶**: `app/[locale]/page.tsx`

**åŸå› **: æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€»è¾‘æ··æ‚ï¼Œç»„ä»¶åˆ’åˆ†ä¸æ¸…

**ä¼˜åŒ–æ­¥éª¤**:

åˆ›å»ºæ–°ç»„ä»¶ `components/LanguageSelector.tsx`:

```typescript
// components/LanguageSelector.tsx
'use client';

import { Languages } from 'lucide-react';
import { Link } from '@/i18n/routing';
import { locales } from '@/i18n.config';
import { LANGUAGE_NAMES } from '@/lib/metadata';
import { useMemo } from 'react';

interface LanguageSelectorProps {
  currentLocale: string;
}

export function LanguageSelector({ currentLocale }: LanguageSelectorProps) {
  // âœ… ä½¿ç”¨ useMemo é¿å…æ¯æ¬¡éƒ½ç”Ÿæˆ locales åˆ—è¡¨
  const localesList = useMemo(() => {
    return locales.map(loc => ({
      code: loc,
      name: LANGUAGE_NAMES[loc]
    }));
  }, []);

  return (
    <div className="relative group">
      <button className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition border border-gray-200 dark:border-gray-700">
        <Languages size={20} />
        <span>{LANGUAGE_NAMES[currentLocale]}</span>
      </button>

      <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
        {localesList.map(({ code, name }, index) => (
          <Link
            key={code}
            href="/"
            locale={code}
            className={`block px-4 py-2 hover:bg-lime-100 dark:hover:bg-lime-900/30 transition ${
              code === currentLocale ? 'bg-lime-50 dark:bg-lime-900/20 font-semibold' : ''
            } ${index === 0 ? 'rounded-t-lg' : ''} ${index === localesList.length - 1 ? 'rounded-b-lg' : ''}`}
          >
            {name}
          </Link>
        ))}
      </div>
    </div>
  );
}
```

ä¿®æ”¹ `app/[locale]/page.tsx`:

```typescript
import { useTranslations } from 'next-intl';
import { Calculator } from '@/components/Calculator';
import { FAQ } from '@/components/FAQ';
import { LanguageSelector } from '@/components/LanguageSelector';

export default async function Home({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;

  return (
    <main className="min-h-screen bg-gradient-to-br from-lime-50 via-white to-blue-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 py-12">
      <div className="container mx-auto px-4">
        <header className="flex justify-between items-center mb-12">
          <div>
            <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-lime-400 to-blue-500 bg-clip-text text-transparent">
              <HomeTitle />
            </h1>
            <p className="text-gray-600 dark:text-gray-400 mt-2">
              <HomeDescription />
            </p>
          </div>

          <LanguageSelector currentLocale={locale} />
        </header>

        <Calculator />
        <FAQ />

        <footer className="mt-16 text-center text-gray-500 dark:text-gray-400 text-sm">
          <p>Marathon Pace Calculator - Built with Next.js & Framer Motion</p>
        </footer>
      </div>
    </main>
  );
}

function HomeTitle() {
  const t = useTranslations();
  return <>{t('title')}</>;
}

function HomeDescription() {
  const t = useTranslations();
  return <>{t('description')}</>;
}
```

**é¢„æœŸæ”¹è¿›**: CPU â†“ 12-18%

---

### æ–¹æ¡ˆ 5: æ¶ˆæ¯æ–‡ä»¶é™æ€å¯¼å…¥ï¼ˆæ”¶ç›Š: 10-15%ï¼‰

**æ–‡ä»¶**: `i18n.ts`

**åŸå› **: åŠ¨æ€å¯¼å…¥æ¨¡æ¿å­—ç¬¦ä¸²å¼€é”€å¤§

**ä¼˜åŒ–æ­¥éª¤**:

```typescript
// i18n.ts - ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå¦‚æœæ¶ˆæ¯æ–‡ä»¶ä¸ä¼šåŠ¨æ€å˜åŒ–ï¼‰
import { getRequestConfig } from 'next-intl/server';
import { routing } from './i18n.config';
import enMessages from './messages/en.json';
import zhMessages from './messages/zh.json';
import frMessages from './messages/fr.json';
import esMessages from './messages/es.json';

const messagesByLocale = {
  en: enMessages,
  zh: zhMessages,
  fr: frMessages,
  es: esMessages,
} as const;

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale;

  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale;
  }

  return {
    locale,
    messages: messagesByLocale[locale as keyof typeof messagesByLocale]
  };
});
```

**é¢„æœŸæ”¹è¿›**: CPU â†“ 10-15%

---

## ğŸ“‹ å®æ–½æ­¥éª¤ï¼ˆæ¨èé¡ºåºï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼ˆå¿«é€Ÿæ”¶ç›Šï¼‰- ç«‹å³å®æ–½
1. âœ… **ä¼˜åŒ–ä¸­é—´ä»¶ matcher** (20-25% æ”¶ç›Š) - 5 åˆ†é’Ÿ
2. âœ… **æå–å…ƒæ•°æ®å¸¸é‡** (8-12% æ”¶ç›Š) - 10 åˆ†é’Ÿ
3. âœ… **ä¼˜åŒ– LanguageSelector ç»„ä»¶** (12-18% æ”¶ç›Š) - 15 åˆ†é’Ÿ

**é¢„æœŸæ€»æ”¶ç›Š: 40-55% CPU é™ä½**

### ç¬¬äºŒé˜¶æ®µï¼ˆä¸­æœŸæ”¶ç›Šï¼‰- éƒ¨ç½²åç›‘æ§
4. âœ… **æ¶ˆæ¯æ–‡ä»¶é¢„åŠ è½½ + ç¼“å­˜** (15-20% æ”¶ç›Š) - 15 åˆ†é’Ÿ
5. âœ… **æ¶ˆæ¯æ–‡ä»¶é™æ€å¯¼å…¥** (10-15% æ”¶ç›Š) - 5 åˆ†é’Ÿ

**é¢„æœŸç´¯è®¡æ”¶ç›Š: 65-90% CPU é™ä½**

---

## ğŸ”§ è¯¦ç»†å®æ–½æŒ‡å—

### Step 1: å¤‡ä»½ç°æœ‰æ–‡ä»¶
```bash
git add .
git commit -m "backup: before i18n optimization"
```

### Step 2: å®æ–½æ–¹æ¡ˆ 1 - ä¼˜åŒ–ä¸­é—´ä»¶
```bash
# ç¼–è¾‘ middleware.ts
nano middleware.ts
```

### Step 3: å®æ–½æ–¹æ¡ˆ 2 - æå–å…ƒæ•°æ®å¸¸é‡
```bash
# åˆ›å»ºæ–°æ–‡ä»¶
touch lib/metadata.ts

# ç¼–è¾‘ layout.tsx å’Œ page.tsx
```

### Step 4: å®æ–½æ–¹æ¡ˆ 3 - æå– LanguageSelector
```bash
# åˆ›å»ºæ–°ç»„ä»¶
touch components/LanguageSelector.tsx

# ç¼–è¾‘ page.tsx
```

### Step 5: æµ‹è¯•
```bash
npm run build
npm run start
# åœ¨ Chrome DevTools Performance æ ‡ç­¾é¡µè®°å½•æ€§èƒ½æŒ‡æ ‡
```

### Step 6: éƒ¨ç½²
```bash
git add .
git commit -m "perf: optimize i18n routing CPU usage"
git push origin main
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”è¡¨

| ä¼˜åŒ–é¡¹ | CPU å ç”¨é™ä½ | å®æ–½éš¾åº¦ | å®æ–½æ—¶é—´ |
|--------|-------------|---------|---------|
| ä¼˜åŒ–ä¸­é—´ä»¶ matcher | 20-25% | ğŸŸ¢ ç®€å• | 5 åˆ†é’Ÿ |
| æå–å…ƒæ•°æ®å¸¸é‡ | 8-12% | ğŸŸ¢ ç®€å• | 10 åˆ†é’Ÿ |
| ä¼˜åŒ– LanguageSelector | 12-18% | ğŸŸ¢ ç®€å• | 15 åˆ†é’Ÿ |
| æ¶ˆæ¯æ–‡ä»¶é¢„åŠ è½½ç¼“å­˜ | 15-20% | ğŸŸ¡ ä¸­ç­‰ | 15 åˆ†é’Ÿ |
| æ¶ˆæ¯æ–‡ä»¶é™æ€å¯¼å…¥ | 10-15% | ğŸŸ¡ ä¸­ç­‰ | 5 åˆ†é’Ÿ |
| **æ€»è®¡** | **65-90%** | - | **50 åˆ†é’Ÿ** |

---

## âœ… éªŒè¯æ¸…å•

- [ ] æœ¬åœ°å¼€å‘ç¯å¢ƒæµ‹è¯•æ‰€æœ‰è¯­è¨€åˆ‡æ¢
- [ ] éªŒè¯ metadata æ˜¯å¦æ­£ç¡®åŠ è½½
- [ ] ä½¿ç”¨ Chrome DevTools Performance è®°å½•å…³é”®æŒ‡æ ‡
- [ ] æµ‹è¯•ä¸åŒè¯­è¨€çš„ SEO metadata
- [ ] æµ‹è¯•ç§»åŠ¨è®¾å¤‡ (ä½åŠŸè€—)
- [ ] éªŒè¯ç”Ÿäº§æ„å»º (`npm run build`)
- [ ] éƒ¨ç½²åˆ° Vercel å 7 å¤©å†…ç›‘æ§ Analytics

---

## ğŸ¯ é¢„æœŸç»“æœ

### ä¼˜åŒ–å‰
- ä¸­é—´ä»¶è°ƒç”¨: é«˜é¢‘
- æ¶ˆæ¯åŠ è½½: åŠ¨æ€æ¯æ¬¡åŠ è½½
- é¡µé¢åˆ‡æ¢æ—¶é—´: 500-800ms
- CPU å ç”¨: é«˜

### ä¼˜åŒ–å
- ä¸­é—´ä»¶è°ƒç”¨: ä»… locale è·¯ç”±æ—¶è°ƒç”¨
- æ¶ˆæ¯åŠ è½½: ä»ç¼“å­˜è¯»å–
- é¡µé¢åˆ‡æ¢æ—¶é—´: 100-200ms â¬‡ï¸ 60-75%
- CPU å ç”¨: â¬‡ï¸ 65-90%

---

## ğŸ“ å¸¸è§é—®é¢˜

**Q: è¿™äº›ä¼˜åŒ–ä¼šå½±å“ç”¨æˆ·ä½“éªŒå—ï¼Ÿ**
A: ä¸ä¼šã€‚è¿™äº›éƒ½æ˜¯å†…éƒ¨æ€§èƒ½ä¼˜åŒ–ï¼Œå¯¹ç”¨æˆ·ç•Œé¢æ²¡æœ‰ä»»ä½•æ”¹å˜ã€‚

**Q: éœ€è¦ä¿®æ”¹ç”¨æˆ·å·²æœ‰çš„ URL å—ï¼Ÿ**
A: ä¸éœ€è¦ã€‚`localePrefix: 'as-needed'` ä¼šè‡ªåŠ¨ä¿æŒ URL å…¼å®¹æ€§ã€‚

**Q: å¯ä»¥é€æ­¥åº”ç”¨è¿™äº›ä¼˜åŒ–å—ï¼Ÿ**
A: å®Œå…¨å¯ä»¥ã€‚å»ºè®®å…ˆå®æ–½ç¬¬ä¸€é˜¶æ®µ (1-3)ï¼Œæµ‹è¯•æ— è¯¯åå†å®æ–½ç¬¬äºŒé˜¶æ®µã€‚

**Q: å¦‚ä½•ç›‘æ§ä¼˜åŒ–æ•ˆæœï¼Ÿ**
A: éƒ¨ç½²åç™»å½• Vercel Dashboard â†’ Analytics â†’ å¯¹æ¯”ä¼˜åŒ–å‰åçš„ CPU Usage æŒ‡æ ‡ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- å‰ç½®æ–‡æ¡£: `docs/æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š.md` (ç»„ä»¶å±‚é¢ä¼˜åŒ–)
- å‚è€ƒæ–‡æ¡£: `docs/CPUä¼˜åŒ–å¿«é€Ÿå‚è€ƒ.md`
- Next.js i18n å®˜æ–¹æ–‡æ¡£: https://next-intl-docs.vercel.app/


